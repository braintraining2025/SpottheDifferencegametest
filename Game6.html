<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ¢ ãŠã§ã‚“é–“é•ã„æ¢ã— ğŸ¢</title>
<style>
    body { font-family: "Helvetica Neue", Arial, sans-serif; text-align: center; background-color: #f9f7f2; padding: 20px; }
    h1 { color: #5d4037; margin-bottom: 5px; }
    p { color: #666; margin-top: 0; }

    /* --- ã‚¿ã‚¤ãƒãƒ¼é–¢é€£ --- */
    #timer-area { width: 80%; max-width: 600px; margin: 10px auto 20px; }
    #timer-bar-bg { width: 100%; height: 20px; background-color: #e0e0e0; border-radius: 10px; overflow: hidden; box-shadow: inset 0 1px 3px rgba(0,0,0,0.2); }
    #timer-bar { width: 100%; height: 100%; background-color: #4caf50; transition: width 1s linear, background-color 1s; }
    #timer-text { font-weight: bold; color: #d84315; margin-bottom: 5px; display: block; }

    /* ã‚²ãƒ¼ãƒ ã‚¨ãƒªã‚¢ã¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®å…±é€šè¨­å®š */
    .game-container { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; max-width: 1200px; margin: 0 auto; position: relative; }
    .image-wrapper { position: relative; border: 4px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.15); border-radius: 8px; overflow: hidden; cursor: crosshair; width: 48%; min-width: 300px; }
    img { display: block; width: 100%; height: auto; user-select: none; -webkit-user-drag: none; }

    /* --- ã‚¹ã‚¿ãƒ¼ãƒˆ/ã‚¯ãƒªã‚¢/ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ --- */
    #start-overlay {
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(255, 255, 255, 0.95);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: #5d4037;
        font-size: 1.5rem;
        font-weight: bold;
        z-index: 200;
    }
    
    #overlay-message { font-size: 2rem; margin-bottom: 20px; }

    .start-button {
        padding: 15px 30px;
        background-color: #e60033;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1.2rem;
        cursor: pointer;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        transition: background-color 0.2s;
    }
    .start-button:hover { background-color: #d32f2f; }

    /* ãã®ä»–ãƒãƒ¼ã‚¯ã¯çœç•¥ */
    .circle { position: absolute; border: 4px solid #e60033; border-radius: 50%; width: 10%; height: 0; padding-bottom: 10%; transform: translate(-50%, -50%); box-shadow: 0 0 5px rgba(0,0,0,0.3); pointer-events: none; animation: pop 0.3s ease-out; }
    .cross { position: absolute; width: 8%; height: 8%; pointer-events: none; transform: translate(-50%, -50%); animation: fadeOut 1s forwards; }
    .cross::before, .cross::after { content: ''; position: absolute; width: 100%; height: 4px; background-color: #0095d9; top: 50%; left: 0; border-radius: 2px; box-shadow: 0 0 3px rgba(255,255,255,0.8); }
    .cross::before { transform: rotate(45deg); }
    .cross::after { transform: rotate(-45deg); }

    @keyframes pop { 0% { transform: translate(-50%, -50%) scale(0); } 80% { transform: translate(-50%, -50%) scale(1.2); } 100% { transform: translate(-50%, -50%) scale(1); } }
    @keyframes fadeOut { 0% { opacity: 1; } 100% { opacity: 0; } }

    #status { font-size: 1.5rem; font-weight: bold; color: #d84315; margin: 10px 0; min-height: 1.5em;}
    #dev-tool { display: none; background: #333; color: #0f0; padding: 10px; text-align: left; }
</style>
</head>
<body>

    <h1>ğŸ¢ ãŠã§ã‚“é–“é•ã„æ¢ã— ğŸ¢</h1>
    <div id="timer-area">
        <span id="timer-text">æ®‹ã‚Šæ™‚é–“: 60ç§’</span>
        <div id="timer-bar-bg"><div id="timer-bar"></div></div>
    </div>

    <div id="status">æ®‹ã‚Š 3 å€‹</div>

    <div class="game-container">
        <div id="start-overlay">
            <div id="overlay-message">é–“é•ã„æ¢ã—ã‚¹ã‚¿ãƒ¼ãƒˆï¼</div>
            <button class="start-button" onclick="startGame()">ã‚¹ã‚¿ãƒ¼ãƒˆï¼</button>
        </div>

        <div class="image-wrapper"><img src="oden_left.jpg" alt="æ­£ã—ã„ç”»åƒ"></div>
        <div class="image-wrapper" id="game-area"><img src="oden_right.jpg" alt="é–“é•ã„ç”»åƒ"></div>
    </div>

    <div id="dev-tool"><div id="coord-output"></div></div>
    <button onclick="toggleDevMode()" style="margin-top:30px; padding:5px; border:none; background:none; color:#ccc;">(é–‹ç™ºè€…ç”¨)</button>

    <script>
        // --- è¨­å®š ---
        const soundOkSrc = 'ok.mp3';
        const soundNgSrc = 'ng.mp3';
        const soundClearSrc = 'clear.mp3';
        const bgmSrc = 'bgm.mp3'; // BGMã®ãƒ•ã‚¡ã‚¤ãƒ«å

        // ãƒ†ãƒ³ãƒ/ãƒ”ãƒƒãƒå¤‰æ›´ã®é–¾å€¤ã¨è¨­å®šå€¤
        const tempoChangeTime = 10; // æ®‹ã‚Š10ç§’ã§ãƒ†ãƒ³ãƒã‚¢ãƒƒãƒ—
        const normalRate = 1.0;
        const fastRate = 1.2;
        
        const timeLimit = 60; 
        const initialDifferences = [
            { id: 1, x: 50.0, y: 82.0, r: 12, found: false },
            { id: 2, x: 90.0, y: 50.0, r: 12, found: false },
            { id: 3, x: 54.0, y: 34.0, r: 10, found: false }
        ];

        // Web Audio APIé–¢é€£ã®å¤‰æ•°
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();
        let bgmBuffer = null;
        let bgmSource = null;

        // å¤‰æ•°
        let differences = JSON.parse(JSON.stringify(initialDifferences));
        let timeLeft = timeLimit;
        let timerId = null;
        let isGameActive = false;
        let foundCount = 0;
        let isDevMode = false;
        const totalCount = initialDifferences.length;

        // è¦ç´ ã®å–å¾—
        const gameArea = document.getElementById('game-area');
        const statusDiv = document.getElementById('status');
        const timerBar = document.getElementById('timer-bar');
        const timerText = document.getElementById('timer-text');
        const startOverlay = document.getElementById('start-overlay');
        const overlayMessage = document.getElementById('overlay-message');
        const startButton = document.querySelector('.start-button');
        const devTool = document.getElementById('dev-tool');
        const coordOutput = document.getElementById('coord-output');


        // --- BGMã®æº–å‚™ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã¨ãƒ‡ã‚³ãƒ¼ãƒ‰ï¼‰ ---
        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«BGMãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸€åº¦ã ã‘èª­ã¿è¾¼ã‚€
        fetch(bgmSrc)
            .then(response => response.arrayBuffer())
            .then(arrayBuffer => audioCtx.decodeAudioData(arrayBuffer))
            .then(audioBuffer => {
                bgmBuffer = audioBuffer;
            })
            .catch(e => console.error("BGMãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã¾ãŸã¯ãƒ‡ã‚³ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ:", e));


        // --- ã‚²ãƒ¼ãƒ é–‹å§‹/ãƒªã‚»ãƒƒãƒˆ ---
        function startGame() {
            // 1. BGMã®å†ç”Ÿé–‹å§‹/ãƒªã‚»ãƒƒãƒˆ
            stopBGM();
            if (bgmBuffer) {
                playBGM(normalRate); // é€šå¸¸é€Ÿåº¦ã§å†ç”Ÿé–‹å§‹
            }

            // 2. å¤‰æ•°ãƒªã‚»ãƒƒãƒˆ
            differences = JSON.parse(JSON.stringify(initialDifferences));
            timeLeft = timeLimit;
            foundCount = 0;
            isGameActive = true;
            
            // 3. ç”»é¢ãƒªã‚»ãƒƒãƒˆ
            startOverlay.style.display = 'none';
            statusDiv.innerText = `æ®‹ã‚Š ${totalCount} å€‹`;
            document.querySelectorAll('.circle').forEach(el => el.remove()); 

            // 4. ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
            if (timerId) clearInterval(timerId);
            startTimer();
            updateTimerDisplay();
        }

        // --- BGMå†ç”Ÿã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« ---

        // BGMã®å†ç”Ÿ
        function playBGM(rate) {
            bgmSource = audioCtx.createBufferSource();
            bgmSource.buffer = bgmBuffer;
            bgmSource.loop = true; // ãƒ«ãƒ¼ãƒ—å†ç”Ÿè¨­å®š
            bgmSource.playbackRate.value = rate; // å†ç”Ÿé€Ÿåº¦ï¼ˆãƒ”ãƒƒãƒï¼‰
            bgmSource.connect(audioCtx.destination);
            bgmSource.start(0);
        }

        // BGMã®åœæ­¢
        function stopBGM() {
            if (bgmSource) {
                bgmSource.stop();
                bgmSource.disconnect();
                bgmSource = null;
            }
        }
        
        // --- ã‚¿ã‚¤ãƒãƒ¼æ©Ÿèƒ½ ---
        function startTimer() {
            timerId = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                if (timeLeft <= 0) gameOver();
            }, 1000);
        }

        function updateTimerDisplay() {
            const percentage = (timeLeft / timeLimit) * 100;
            timerBar.style.width = percentage + "%";
            timerBar.style.backgroundColor = (percentage < 20) ? "#d32f2f" : ((percentage < 50) ? "#fbc02d" : "#4caf50");
            timerText.innerText = `æ®‹ã‚Šæ™‚é–“: ${timeLeft}ç§’`;
            
            // BGMã®ãƒ†ãƒ³ãƒ/ãƒ”ãƒƒãƒå¤‰æ›´ãƒ­ã‚¸ãƒƒã‚¯
            if (bgmSource) {
                if (timeLeft <= tempoChangeTime && bgmSource.playbackRate.value !== fastRate) {
                    // æ®‹ã‚Š10ç§’ä»¥ä¸‹ã§ãƒ†ãƒ³ãƒã‚¢ãƒƒãƒ—
                    bgmSource.playbackRate.setValueAtTime(fastRate, audioCtx.currentTime);
                } else if (timeLeft > tempoChangeTime && bgmSource.playbackRate.value !== normalRate) {
                    // ãƒ†ãƒ³ãƒã‚’å…ƒã«æˆ»ã™ï¼ˆãƒªãƒ—ãƒ¬ã‚¤æ™‚ã‚’è€ƒæ…®ï¼‰
                    bgmSource.playbackRate.setValueAtTime(normalRate, audioCtx.currentTime);
                }
            }
        }

        // --- ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ ---
        gameArea.addEventListener('click', function(e) {
            if (!isGameActive) return;
            // ... (åº§æ¨™è¨ˆç®—ã®ã‚³ãƒ¼ãƒ‰ã¯çœç•¥) ...
            const rect = gameArea.getBoundingClientRect();
            const xPercent = ((e.clientX - rect.left) / rect.width) * 100;
            const yPercent = ((e.clientY - rect.top) / rect.height) * 100;
            // ...
            
            if (isDevMode) {
                // é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ã®å‡¦ç†ï¼ˆçœç•¥ï¼‰
            }

            let hit = false;
            differences.forEach(diff => {
                const dx = Math.abs(xPercent - diff.x);
                const dy = Math.abs(yPercent - diff.y);
                if (Math.sqrt(dx*dx + dy*dy) < diff.r && !diff.found) {
                    hit = true;
                    diff.found = true;
                    playSound(soundOkSrc);
                    showCircle(diff.x, diff.y);
                    foundCount++;
                    updateStatus();
                }
            });

            if (!hit) {
                playSound(soundNgSrc);
                showCross(xPercent, yPercent);
            }
        });


        // --- ã‚²ãƒ¼ãƒ çµ‚äº†å‡¦ç† ---
        function gameOver() {
            clearInterval(timerId);
            isGameActive = false;
            stopBGM(); // BGMã‚’åœæ­¢
            
            startOverlay.style.display = 'flex';
            overlayMessage.innerText = "æ®‹å¿µï¼æ™‚é–“åˆ‡ã‚Œã§ã™...";
            startButton.innerText = "ã‚‚ã†ä¸€åº¦éŠã¶";
            statusDiv.innerText = "æ®‹å¿µ... æ™‚é–“åˆ‡ã‚Œã§ã™";
        }

        function gameClear() {
            clearInterval(timerId);
            isGameActive = false;
            stopBGM(); // BGMã‚’åœæ­¢
            
            setTimeout(() => {
                playSound(soundClearSrc);
            }, 300); 

            startOverlay.style.display = 'flex';
            overlayMessage.innerHTML = "ğŸ† å®Œå…¨ã‚¯ãƒªã‚¢ãŠã‚ã§ã¨ã†ï¼ ğŸ†";
            startButton.innerText = "ã‚‚ã†ä¸€åº¦éŠã¶";
            statusDiv.innerHTML = `ğŸ‰ ã‚¯ãƒªã‚¢ï¼æ®‹ã‚Šæ™‚é–“ ${timeLeft}ç§’ ğŸ‰`;
            statusDiv.style.color = "#2e7d32";
        }

        // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
        function playSound(src) {
            // SEã¯æ–°ã—ã„Audioã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§å†ç”Ÿ
            const audio = new Audio(src);
            audio.currentTime = 0;
            audio.play().catch(e => console.error("SEå†ç”Ÿã‚¨ãƒ©ãƒ¼:", e));
        }

        function showCircle(x, y, isTemp = false) {
            const circle = document.createElement('div');
            circle.classList.add('circle');
            circle.style.left = x + '%';
            circle.style.top = y + '%';
            if(isTemp) { circle.style.borderColor = 'blue'; setTimeout(() => circle.remove(), 1000); }
            gameArea.appendChild(circle);
        }

        function showCross(x, y) {
            const cross = document.createElement('div');
            cross.classList.add('cross');
            cross.style.left = x + '%';
            cross.style.top = y + '%';
            gameArea.appendChild(cross);
            setTimeout(() => cross.remove(), 1000);
        }

        function updateStatus() {
            const remain = totalCount - foundCount;
            if (remain === 0) gameClear();
            else statusDiv.innerText = `æ®‹ã‚Š ${remain} å€‹`;
        }
        
        function toggleDevMode() {
            isDevMode = !isDevMode;
            devTool.style.display = isDevMode ? 'block' : 'none';
        }

        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã€éŸ³å£°ã‚’ä¸€åº¦é³´ã‚‰ã™è¨±å¯ã‚’å¾—ã‚‹ãŸã‚ã«ãƒ€ãƒŸãƒ¼ã®å†ç”Ÿã‚’è©¦ã¿ã‚‹
        // Mac/ãƒ–ãƒ©ã‚¦ã‚¶ã®åˆ¶é™å¯¾ç­–
        startOverlay.addEventListener('click', () => {
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }, { once: true });
    </script>
</body>
</html>